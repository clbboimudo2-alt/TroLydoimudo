def desired_model():
    # Đọc tên model từ file và chuẩn hóa
    try:
        raw = rfile("module_chatgpt.txt").strip()
    except Exception:
        raw = ""
    alias = (raw or "").strip().lower()

    # Bản đồ alias → tên hợp lệ
    alias_map = {
        "gpt-5": "gpt-5",
        "gpt5": "gpt-5",
        "gpt-5-chat-latest": "gpt-5-chat-latest",
        "gpt-4o": "gpt-4o",
        "gpt-4o-mini": "gpt-4o-mini",
    }

    # Nếu người dùng ghi "GPT-5" hay "Gpt-5"… vẫn map về "gpt-5"
    if alias in alias_map:
        return alias_map[alias]

    # Fallback khi tên lạ/không có quyền: chọn model phổ biến, rẻ và ổn
    return "gpt-4o-mini"

model_name = desired_model()

stream = client.chat.completions.create(
    model=model_name,
    messages=[{"role": m["role"], "content": m["content"]} for m in st.session_state.messages],
    stream=True,
)
